<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AV Syndicate Manager - Full Persistence v3.0</title>
    
    <!-- Force cache reload -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ================== API CONFIGURATION ==================
        const API_BASE_URL = 'https://kateg.app.n8n.cloud/webhook';
        const USE_MOCK_DATA = false;
        
        // n8n Webhook Endpoints
        const N8N_ENDPOINTS = {
          GET_INITIAL_DATA: '/get-initial-data',
          ADD_DEAL: '/add-deal',
          SAVE_DEAL: '/save-deal',
          DELETE_DEAL: '/delete-deal',
          PRIORITIZE_SYNDICATES: '/prioritize-syndicates',
          CALCULATE_RESERVATION: '/calculate-reservation',
          ADD_SYNDICATE: '/add-syndicate',
          UPDATE_SYNDICATE: '/update-syndicate',
          DELETE_SYNDICATE: '/delete-syndicate',
          SAVE_CONTROLS: '/save-controls'
        };

        // ================== EVENT LOGGING UTILITY ==================
        const logEvent = async (eventType, dealId, eventSource, payload, snapshotAfter) => {
          try {
            const eventLog = {
              event_id: `EVT_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
              event_timestamp: new Date().toISOString(),
              deal_id: dealId || '',
              event_type: eventType,
              event_source: eventSource,
              payload: JSON.stringify(payload),
              snapshot_after: JSON.stringify(snapshotAfter)
            };
            
            console.log('üìù Logging event:', eventLog);
            
            // This will be handled by n8n's /save-deal endpoint which will append to event log
            return eventLog;
          } catch (err) {
            console.error('‚ùå Event logging failed:', err);
          }
        };
        
        // API Helper Functions
        const api = {
          async get(endpoint) {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
              method: 'GET',
              headers: { 'Content-Type': 'application/json' }
            });
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            return response.json();
          },
          
          async post(endpoint, data) {
            console.log('üîµ API.POST START');
            console.log('  Endpoint:', endpoint);
            console.log('  Full URL:', `${API_BASE_URL}${endpoint}`);
            console.log('  Payload:', data);
            
            try {
              const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
              });
              
              console.log('  Response status:', response.status);
              console.log('  Response OK?', response.ok);
              
              if (!response.ok) {
                const errorText = await response.text();
                console.error('  ‚ùå Response not OK:', errorText);
                throw new Error(`API Error: ${response.statusText}`);
              }
              
              const result = await response.json();
              console.log('  ‚úÖ Response data:', result);
              return result;
              
            } catch (error) {
              console.error('  ‚ùå Fetch error:', error);
              throw error;
            }
          },
          
          async put(endpoint, data) {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            return response.json();
          },
          
          async delete(endpoint) {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' }
            });
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            return response.json();
          }
        };

        // ================== MAIN APP COMPONENT ==================
        const App = () => {
          const [data, setData] = useState({ deals: [], syndicates: [], sponsorTeams: [], funds: [], globalSettings: {} });
          const [loading, setLoading] = useState(true);

          useEffect(() => {
            loadData();
          }, []);

          const loadData = async () => {
            try {
              console.log('üîÑ Loading initial data from:', API_BASE_URL + N8N_ENDPOINTS.GET_INITIAL_DATA);
              const result = await api.get(N8N_ENDPOINTS.GET_INITIAL_DATA);
              console.log('‚úÖ Data loaded:', result);
              setData(result);
              setLoading(false);
            } catch (err) {
              console.error('‚ùå Failed to load data:', err);
              alert('Failed to load data: ' + err.message);
              setLoading(false);
            }
          };

          // ================== DEAL PERSISTENCE HANDLERS ==================
          
          const handleSaveDeal = async (dealData, eventType = 'deal_saved') => {
            console.log('üíæ SAVE DEAL TRIGGERED');
            console.log('  Deal ID:', dealData.deal_id || dealData.id);
            console.log('  Event Type:', eventType);
            console.log('  Full Deal Data:', dealData);
            
            try {
              // Build complete save payload
              const savePayload = {
                deal_id: dealData.deal_id || dealData.id,
                company_name: dealData.company_name || '',
                round_size: dealData.round_size || '',
                thesis: dealData.thesis || '',
                stage: dealData.stage || '',
                sector: dealData.sector || '',
                geography: dealData.geography || '',
                valuation: dealData.valuation || '',
                status: dealData.status || '',
                sponsor_team: dealData.sponsor_team || '',
                target_reservation: dealData.target_reservation || '',
                actual_reservation: dealData.actual_reservation || '',
                dd_report_text: dealData.dd_report_text || '',
                sent_to_syndicates: dealData.sent_to_syndicates || '',
                locked_deal: dealData.locked_deal ? 'TRUE' : 'FALSE',
                created_date: dealData.created_date || new Date().toISOString().split('T')[0],
                
                // Syndicate selections (pipe-delimited format)
                selected_syndicates: Array.isArray(dealData.selected_syndicates) 
                  ? dealData.selected_syndicates.map(s => s.id || s).join('|')
                  : dealData.selected_syndicates || '',
                  
                selected_syndicate_names: Array.isArray(dealData.selected_syndicates)
                  ? dealData.selected_syndicates.map(s => s.name || s).join('|')
                  : dealData.selected_syndicate_names || '',
                  
                syndicate_priorities: Array.isArray(dealData.selected_syndicates)
                  ? dealData.selected_syndicates.map((s, i) => s.priority || (i + 1)).join('|')
                  : dealData.syndicate_priorities || '',
                
                // Event metadata for logging
                event_type: eventType,
                event_source: 'deal',
                event_timestamp: new Date().toISOString()
              };
              
              console.log('üì§ Sending save payload:', savePayload);
              
              // Call n8n save endpoint
              const result = await api.post(N8N_ENDPOINTS.SAVE_DEAL, savePayload);
              console.log('‚úÖ Save successful:', result);
              
              // Update local state
              const updatedDeals = data.deals.map(d => 
                (d.deal_id === savePayload.deal_id || d.id === savePayload.deal_id) 
                  ? { ...d, ...dealData } 
                  : d
              );
              setData({ ...data, deals: updatedDeals });
              
              alert('‚úÖ Deal saved successfully!');
              return result;
              
            } catch (err) {
              console.error('‚ùå SAVE ERROR:', err);
              alert('Failed to save deal: ' + err.message + '\n\nCheck browser console for details.');
              throw err;
            }
          };

          const handleDeleteDeal = async (dealId) => {
            if (!window.confirm('Are you sure you want to delete this deal?')) return;
            
            console.log('üóëÔ∏è DELETE DEAL TRIGGERED');
            console.log('  Deal ID:', dealId);
            
            try {
              // Log deletion event via save endpoint
              await handleSaveDeal({
                deal_id: dealId,
                status: 'DELETED',
                deleted_at: new Date().toISOString()
              }, 'deal_deleted');
              
              // Update local state
              const updatedDeals = data.deals.filter(d => d.deal_id !== dealId && d.id !== dealId);
              setData({ ...data, deals: updatedDeals });
              
              console.log('‚úÖ Deal deleted successfully');
              
            } catch (err) {
              console.error('‚ùå Delete failed:', err);
              alert('Failed to delete deal: ' + err.message);
            }
          };

          const handleUpdateDeal = async (updatedDeal) => {
            console.log('üîÑ UPDATE DEAL TRIGGERED');
            console.log('  Updated Deal:', updatedDeal);
            
            await handleSaveDeal(updatedDeal, 'deal_updated');
          };
          
          const handleSaveSyndicateSelection = async (dealId, selectedSyndicates) => {
            console.log('üìã SAVE SYNDICATE SELECTION TRIGGERED');
            console.log('  Deal ID:', dealId);
            console.log('  Selected Syndicates:', selectedSyndicates);
            
            try {
              const deal = data.deals.find(d => d.deal_id === dealId || d.id === dealId);
              if (!deal) throw new Error('Deal not found');
              
              // Build syndicate selection payload
              const syndicatePayload = {
                ...deal,
                selected_syndicates: selectedSyndicates,
                sent_to_syndicates: 'TRUE'
              };
              
              await handleSaveDeal(syndicatePayload, 'syndicate_selection_saved');
              
            } catch (err) {
              console.error('‚ùå Syndicate selection save failed:', err);
              alert('Failed to save syndicate selection: ' + err.message);
            }
          };

          // ================== SYNDICATE PERSISTENCE HANDLERS ==================
          
          const handleAddSyndicate = async (newSyndicate) => {
            console.log('üü¢ ADD SYNDICATE TRIGGERED');
            console.log('  Input data:', newSyndicate);
            
            try {
              const syndicateWithId = { 
                ...newSyndicate, 
                syndicate_id: `SYN${Date.now()}`,
                id: `SYN${Date.now()}`
              };
              
              console.log('  Generated ID:', syndicateWithId.syndicate_id);
              
              // Prepare save payload
              const savePayload = {
                syndicate_id: syndicateWithId.syndicate_id,
                syndicate_name: newSyndicate.syndicate_name || newSyndicate.name || '',
                description: newSyndicate.description || '',
                investment_thesis: newSyndicate.investment_thesis || newSyndicate.mandate || '',
                type: newSyndicate.type || 'standard',
                member_ids: Array.isArray(newSyndicate.member_ids) 
                  ? newSyndicate.member_ids.join('|')
                  : newSyndicate.member_ids || '',
                dates_of_deals: newSyndicate.dates_of_deals || '',
                allows_multiple_concurrent: newSyndicate.allows_multiple_concurrent ? 'TRUE' : 'FALSE',
                event_type: 'syndicate_created',
                event_source: 'syndicate',
                event_timestamp: new Date().toISOString()
              };
              
              console.log('üì§ Sending syndicate save:', savePayload);
              
              const result = await api.post(N8N_ENDPOINTS.ADD_SYNDICATE, savePayload);
              console.log('‚úÖ Syndicate saved:', result);
              
              // Update local state
              setData({ ...data, syndicates: [...data.syndicates, syndicateWithId] });
              
              alert('‚úÖ Syndicate saved successfully!');
              
            } catch (err) {
              console.error('‚ùå Add syndicate failed:', err);
              alert('Failed to create syndicate: ' + err.message);
            }
          };

          const handleUpdateSyndicate = async (updatedSyndicate) => {
            console.log('üîÑ UPDATE SYNDICATE TRIGGERED');
            console.log('  Updated Syndicate:', updatedSyndicate);
            
            try {
              const savePayload = {
                syndicate_id: updatedSyndicate.syndicate_id || updatedSyndicate.id,
                syndicate_name: updatedSyndicate.syndicate_name || updatedSyndicate.name,
                description: updatedSyndicate.description || '',
                investment_thesis: updatedSyndicate.investment_thesis || updatedSyndicate.mandate || '',
                type: updatedSyndicate.type || 'standard',
                member_ids: Array.isArray(updatedSyndicate.member_ids)
                  ? updatedSyndicate.member_ids.join('|')
                  : updatedSyndicate.member_ids || '',
                dates_of_deals: updatedSyndicate.dates_of_deals || '',
                allows_multiple_concurrent: updatedSyndicate.allows_multiple_concurrent ? 'TRUE' : 'FALSE',
                event_type: 'syndicate_updated',
                event_source: 'syndicate',
                event_timestamp: new Date().toISOString()
              };
              
              const result = await api.post(N8N_ENDPOINTS.UPDATE_SYNDICATE, savePayload);
              console.log('‚úÖ Syndicate updated:', result);
              
              // Update local state
              const updatedSyndicates = data.syndicates.map(s => 
                (s.syndicate_id === savePayload.syndicate_id || s.id === savePayload.syndicate_id)
                  ? { ...s, ...updatedSyndicate }
                  : s
              );
              setData({ ...data, syndicates: updatedSyndicates });
              
              alert('‚úÖ Syndicate updated successfully!');
              
            } catch (err) {
              console.error('‚ùå Update syndicate failed:', err);
              alert('Failed to update syndicate: ' + err.message);
            }
          };

          const handleDeleteSyndicate = async (syndicateId) => {
            if (!window.confirm('Are you sure you want to delete this syndicate?')) return;
            
            console.log('üóëÔ∏è DELETE SYNDICATE TRIGGERED');
            console.log('  Syndicate ID:', syndicateId);
            
            try {
              const result = await api.post(N8N_ENDPOINTS.DELETE_SYNDICATE, {
                syndicate_id: syndicateId,
                status: 'DELETED',
                deleted_at: new Date().toISOString(),
                event_type: 'syndicate_deleted',
                event_source: 'syndicate'
              });
              
              console.log('‚úÖ Syndicate deleted:', result);
              
              // Update local state
              const updatedSyndicates = data.syndicates.filter(s => 
                s.syndicate_id !== syndicateId && s.id !== syndicateId
              );
              setData({ ...data, syndicates: updatedSyndicates });
              
            } catch (err) {
              console.error('‚ùå Delete syndicate failed:', err);
              alert('Failed to delete syndicate: ' + err.message);
            }
          };

          // ================== CONTROLS PERSISTENCE ==================
          
          const handleSaveControls = async (controls) => {
            console.log('‚öôÔ∏è SAVE CONTROLS TRIGGERED');
            console.log('  Controls:', controls);
            
            try {
              const savePayload = {
                controls: controls,
                event_type: 'controls_saved',
                event_source: 'controls',
                event_timestamp: new Date().toISOString()
              };
              
              const result = await api.post(N8N_ENDPOINTS.SAVE_CONTROLS, savePayload);
              console.log('‚úÖ Controls saved:', result);
              
              setData({ ...data, globalSettings: { ...data.globalSettings, ...controls } });
              
              alert('‚úÖ Controls saved successfully!');
              
            } catch (err) {
              console.error('‚ùå Save controls failed:', err);
              alert('Failed to save controls: ' + err.message);
            }
          };

          if (loading) {
            return (
              <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <div className="text-center">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                  <p className="mt-4 text-gray-600">Loading data...</p>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gray-50">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <h1 className="text-3xl font-bold text-gray-900 mb-8">AV Syndicate Manager</h1>
                
                {/* Persistence Status Banner */}
                <div className="mb-4 bg-green-50 border-l-4 border-green-400 p-4">
                  <div className="flex">
                    <div className="flex-shrink-0">
                      <svg className="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                      </svg>
                    </div>
                    <div className="ml-3">
                      <p className="text-sm text-green-700">
                        <strong>‚úÖ Full Persistence Active:</strong> All saves go directly to Google Sheets with event logging.
                      </p>
                    </div>
                  </div>
                </div>
                
                <p className="text-gray-600 mb-8">
                  Deals: {data.deals.length} | Syndicates: {data.syndicates.length}
                </p>
                
                {/* Deal Management Section */}
                <div className="bg-white rounded-lg shadow p-6 mb-8">
                  <h2 className="text-xl font-semibold mb-4">Deals</h2>
                  <div className="space-y-2">
                    {data.deals.map(deal => (
                      <div key={deal.deal_id || deal.id} className="flex justify-between items-center p-4 border rounded hover:bg-gray-50">
                        <div>
                          <h3 className="font-medium">{deal.company_name}</h3>
                          <p className="text-sm text-gray-600">
                            {deal.stage} | {deal.sector} | {deal.geography}
                          </p>
                        </div>
                        <div className="flex gap-2">
                          <button
                            onClick={() => {
                              const updated = { ...deal, status: 'Updated' };
                              handleUpdateDeal(updated);
                            }}
                            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                          >
                            Save
                          </button>
                          <button
                            onClick={() => handleDeleteDeal(deal.deal_id || deal.id)}
                            className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                          >
                            Delete
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
                
                {/* Syndicate Management Section */}
                <div className="bg-white rounded-lg shadow p-6">
                  <h2 className="text-xl font-semibold mb-4">Syndicates</h2>
                  <div className="space-y-2">
                    {data.syndicates.map(syndicate => (
                      <div key={syndicate.syndicate_id || syndicate.id} className="flex justify-between items-center p-4 border rounded hover:bg-gray-50">
                        <div>
                          <h3 className="font-medium">{syndicate.syndicate_name || syndicate.name}</h3>
                          <p className="text-sm text-gray-600">{syndicate.description}</p>
                        </div>
                        <div className="flex gap-2">
                          <button
                            onClick={() => {
                              const updated = { ...syndicate, description: syndicate.description + ' (Updated)' };
                              handleUpdateSyndicate(updated);
                            }}
                            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                          >
                            Save
                          </button>
                          <button
                            onClick={() => handleDeleteSyndicate(syndicate.syndicate_id || syndicate.id)}
                            className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                          >
                            Delete
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          );
        };

        // Render app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
